# Changes Made on 2025-12-30

## Summary of Bug Fixes and Improvements

This document summarizes the changes made to fix several reported issues.

---

## 1. Test Fixes (ConfigControllerTest)

### Problem
Multiple `UnnecessaryStubbingException` errors in `ConfigControllerTest` causing test failures.

### Solution
- Made `loadLocalProperties()` stubbing lenient in `setUp()` method using `lenient().doReturn()`.
- Fixed `getConfig_shouldHandleEmptyPasswordValues()` test to properly stub all required mock calls instead of using `anyString()` matchers that conflicted with specific stubbings.

### Files Changed
- `src/test/java/com/kisoft/emaillist/controller/ConfigControllerTest.java`

---

## 2. Table Border Toggle Fix

### Problem
Table border "Show" functionality not working when table is loaded from a template. The toggle would only hide borders, not show them again.

### Root Cause
The `toggleTableBorders()` function used a data attribute `data-borders-visible` to track state. When a table was loaded from a template without this attribute, the function incorrectly assumed borders were visible (even if they were hidden via CSS).

### Solution
Modified `toggleTableBorders()` to detect the actual border state from computed CSS styles when the `data-borders-visible` attribute is not set:
```javascript
if (currentState === null) {
    // Attribute not set - detect actual border state from first cell
    const firstCell = cells[0];
    const computedStyle = window.getComputedStyle(firstCell);
    const borderWidth = computedStyle.borderWidth || computedStyle.borderTopWidth;
    hasBorder = borderWidth && borderWidth !== '0px' && borderWidth !== '0';
}
```

### Files Changed
- `src/main/resources/static/js/app.js` - `toggleTableBorders()` function

---

## 3. PDF Export Improvement

### Problem
PDF export was falling back to browser print dialog instead of generating a proper PDF file.

### Root Cause
The client-side `html2pdf.js` library may not load or work properly in all environments.

### Solution
Changed the export strategy to:
1. First try server-side PDF generation via `/api/export/pdf` API (best quality)
2. Fall back to `html2pdf.js` client-side generation
3. Last resort: browser print dialog

### Files Changed
- `src/main/resources/static/js/app.js` - `exportToPdf()` function

---

## 4. Table Resize After Template Load

### Problem
Table resize handles not working properly on tables loaded from templates.

### Root Cause
The `initTableResizing()` function was being called with too short a timeout (50ms) which may not be enough for DOM to fully render.

### Solution
- Increased timeout from 50ms to 100ms
- Added verification step to check if all tables were initialized
- Added automatic retry if some tables were missed
- Added better logging for debugging

### Files Changed
- `src/main/resources/static/js/app.js` - `setEditorHtml()` function

---

## Test Results

All 218 tests pass after these changes:
```
[INFO] Tests run: 218, Failures: 0, Errors: 0, Skipped: 0
[INFO] BUILD SUCCESS
```

---

## Files Modified Summary

1. **`src/test/java/com/kisoft/emaillist/controller/ConfigControllerTest.java`**
   - Fixed unnecessary stubbing issues
   - Made `loadLocalProperties()` stubbing lenient
   - Added proper mock setups for empty password test

2. **`src/main/resources/static/js/app.js`**
   - Fixed `toggleTableBorders()` to detect actual border state
   - Improved `exportToPdf()` with server-side generation fallback
   - Improved table resize initialization with longer timeout and retry

---

## Notes on Pending Issues

### Email Sending Issue ("2 emails to 1st email")
The code review shows the email sending logic is correct:
- Each email is sent with its own checkbox value
- The server correctly receives and processes each email individually
- Console logging is in place for debugging

If this issue persists, it may be a browser-specific or data-specific issue requiring:
1. Check browser console for JavaScript errors
2. Check server logs for email addresses received
3. Verify email list data doesn't have duplicate entries

### Configuration Dialog Template Slots
The configuration dialog correctly loads and saves the template slots value. The value is:
- Read from `application-local.properties` file (if saved)
- Falls back to Spring Environment properties
- Requires application restart for page to reflect new value (this is by design)

The UI correctly updates template buttons after saving without restart.

---

## Verification Steps

1. **Table Border Toggle**: Create/load a table → Toggle borders → Should show/hide correctly
2. **PDF Export**: Click Export → PDF → Should download a PDF file (not print dialog)
3. **Table Resize**: Load a template with tables → Hover cell edges → Should see resize handles
4. **All Tests**: Run `mvn test` → Should show 218 tests passed


